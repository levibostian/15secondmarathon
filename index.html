<!DOCTYPE html>
<html lang="en">
    <head>
        <title> </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://unpkg.com/tachyons/css/tachyons.min.css">
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>    

        <style>
            iframe {
                aspect-ratio: 16 / 9;
                height: auto;
                width: 100%;
            }
        </style>
    </head>    
  <body>
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
        <div id="player"></div>                

        <script>
            $(document).ready(function() {
                videos = {}
                // we use jquery mostly for this. Being able to load a local json file so we can separate the video data with the webpage logic. 
                $.ajax({
                    dataType: "json",
                    url: 'data.json',
                    async: false,
                    success: function(data) {
                        videos = data 
                    }
                  });
                
                console.log(videos)

                // 2. This code loads the IFrame Player API code asynchronously.
                var tag = document.createElement('script');                                    
                    
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                // 3. This function creates an <iframe> (and YouTube player)
                //    after the API code downloads.
                var player;
                window.onYouTubeIframeAPIReady = function() { // use `window.` to make jquery work https://stackoverflow.com/a/62647994
                    player = new YT.Player('player', {
                        host: 'http://www.youtube-nocookie.com',              
                        playerVars: {
                        'playsinline': 1,
                        'autoplay': 1
                        },
                        events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                        }
                    });
                }

                // 4. The API will call this function when the video player is ready.
                var currentVideoIndex = 0
                var youtubePlayer

                function onPlayerReady(event) {
                    youtubePlayer = event.target 
                    currentVideoIndex = 1
                    
                    startPlayingVideo(1340)
                }

                // 5. The API calls this function when the player's state changes.
                //    The function indicates that when playing a video (state=1),
                //    the player should play for six seconds and then stop.
                function onPlayerStateChange(event) {
                    if (event.data == YT.PlayerState.ENDED) {
                        console.log('video ended')

                        currentVideoIndex += 1
                        console.log(`new index = ${currentVideoIndex}, number of videos: ${videos.videos.length}`)

                        if (currentVideoIndex >= videos.videos.length) {
                            console.log('hit end of videos array. resetting to index 0')
                            currentVideoIndex = 0                            
                        }

                        startPlayingVideo()
                    }
                }

                function stopVideo() {
                    player.stopVideo();
                }

                function startPlayingVideo(offset) {                    
                    videoToPlay = videos.videos[currentVideoIndex]
                    startSeconds = offset || 0
                    console.log(`next video to play ${JSON.stringify(videoToPlay)}, start seconds: ${startSeconds}`)

                    youtubePlayer.loadVideoById({
                        videoId: videoToPlay.watchId,
                        startSeconds: startSeconds
                    });
                }
            })            
        </script>
    
  </body>
</html>